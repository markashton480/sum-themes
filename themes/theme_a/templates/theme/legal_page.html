{% extends "theme/base.html" %}
{% load wagtailcore_tags chrome_tags %}

{% block main_class %}pt-0{% endblock %}

{% block content %}
  {% hero_context page headline=page.title subheadline=page.hero_intro extra_template="sum_core/includes/hero_extras/legal_meta.html" as hero %}
  {% include "sum_core/blocks/hero_gradient.html" with hero=hero %}

  {% if page.sections %}
    <div class="lg:hidden sticky top-0 z-40 bg-sage-linen border-b border-sage-black/10 shadow-sm print:hidden">
      <button
        id="mobile-toc-toggle"
        type="button"
        class="w-full px-6 py-4 flex items-center justify-between text-sage-black hover:bg-sage-oat/30 transition-colors focus:bg-sage-oat/50 rounded-sm"
        aria-expanded="false"
        aria-controls="mobile-toc-menu"
        aria-label="Toggle Table of Contents"
      >
        <span class="font-display text-lg">Jump to Section</span>
        <svg id="mobile-toc-icon" class="w-5 h-5 text-sage-terra transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
      <nav id="mobile-toc-menu" class="bg-sage-oat/20 border-t border-sage-black/5" aria-label="Mobile Table of Contents" hidden>
        <div>
          {% for section in page.sections %}
            {% with section_id=section.value.anchor|slugify %}
              <a
                href="#{{ section_id }}"
                class="block px-6 py-4 text-sm font-bold uppercase tracking-widest text-sage-label hover:text-sage-terra hover:bg-sage-oat/50 border-b border-sage-black/5 transition-colors"
              >
                {{ forloop.counter }}. {{ section.value.heading }}
              </a>
            {% endwith %}
          {% endfor %}
        </div>
      </nav>
    </div>

    <section class="max-w-7xl mx-auto px-6 py-12 lg:py-24">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 relative">
        <aside class="hidden lg:block lg:col-span-3">
          <div class="sticky top-32">
            <span class="block text-xs font-bold uppercase tracking-widest text-sage-black/40 mb-6" aria-hidden="true">
              Contents
            </span>
            <nav class="space-y-4 border-l border-sage-black/10" aria-label="Table of Contents">
              {% for section in page.sections %}
                {% with section_id=section.value.anchor|slugify %}
                  <a
                    href="#{{ section_id }}"
                    class="block pl-4 text-sm text-sage-label hover:text-sage-terra transition-all border-l-2 border-transparent hover:border-sage-terra -ml-[2px] py-1 focus:text-sage-terra focus:font-bold rounded-sm"
                  >
                    {{ forloop.counter }}. {{ section.value.heading }}
                  </a>
                {% endwith %}
              {% endfor %}
            </nav>
          </div>
        </aside>

        <div class="lg:col-span-8 lg:col-start-5">
          {% for section in page.sections %}
            {% with section_id=section.value.anchor|slugify %}
              <article id="{{ section_id }}" class="mb-16 scroll-mt-24 lg:scroll-mt-32">
                <h2 class="font-display text-3xl md:text-4xl text-sage-black leading-tight mb-6">
                  {{ section.value.heading }}
                </h2>
                <div class="space-y-10">
                  {% for item in section.value.content %}
                    {% if item.block_type == "rich_text" %}
                      <div class="prose prose-lg max-w-none text-sage-label font-light leading-relaxed prose-headings:font-display prose-headings:text-2xl prose-a:text-sage-terra prose-strong:text-sage-black prose-li:mb-2">
                        {{ item.value.body|richtext }}
                      </div>
                    {% else %}
                      {% include_block item %}
                    {% endif %}
                  {% endfor %}
                </div>
              </article>
              {% if not forloop.last %}
                <hr class="border-sage-black/10 mb-16" aria-hidden="true">
              {% endif %}
            {% endwith %}
          {% endfor %}
        </div>
      </div>
    </section>
  {% endif %}
{% endblock %}

{% block extra_body %}
  {{ block.super }}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggle = document.getElementById("mobile-toc-toggle");
      const menu = document.getElementById("mobile-toc-menu");
      const icon = document.getElementById("mobile-toc-icon");
      if (!toggle || !menu) {
        return;
      }

      const setExpanded = (expanded) => {
        toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
        menu.hidden = !expanded;
        menu.setAttribute("aria-hidden", expanded ? "false" : "true");
        if (icon) {
          icon.style.transform = expanded ? "rotate(180deg)" : "rotate(0deg)";
        }
      };

      setExpanded(false);

      toggle.addEventListener("click", () => {
        const isExpanded = toggle.getAttribute("aria-expanded") === "true";
        setExpanded(!isExpanded);
      });
    });
  </script>
{% endblock %}
