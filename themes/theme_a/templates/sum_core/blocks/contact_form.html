{% load wagtailcore_tags form_tags %}
<section class="contact-form-block py-24 md:py-32 bg-sage-black text-sage-linen relative overflow-hidden">
  <div class="container mx-auto px-6 relative z-10">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 lg:gap-24 items-start">
      <!-- Header Column -->
      <div class="reveal pt-6 lg:pt-8 lg:sticky lg:top-32 lg:self-start">
        <header class="max-w-md">
          {% if self.eyebrow %}
            <span class="text-sage-terra font-mono text-xs uppercase tracking-widest mb-6 block">
              {{ self.eyebrow }}
            </span>
          {% endif %}
          <div class="font-display text-5xl md:text-6xl lg:text-7xl text-sage-linen mb-8 leading-none">
            {{ self.heading|richtext }}
          </div>
          {% if self.intro %}
            <div class="font-accent text-xl md:text-2xl text-sage-oat/70 leading-relaxed max-w-md">
              {{ self.intro|richtext }}
            </div>
          {% endif %}
        </header>
      </div>

      <!-- Form Column -->
      <div class="reveal delay-100">
        {% with block_id=block.id %}
        <form action="/forms/submit/" method="post" novalidate class="space-y-8 md:space-y-12 js-async-form" data-form-type="contact" id="contact-form{% if block_id %}-{{ block_id }}{% endif %}"
              data-success-message="{{ self.success_message|default:"Thanks, we'll be in touch shortly."|escapejs }}"
              data-error-message="Something went wrong. Please try again.">
          {% csrf_token %}

          <!-- Hidden fields for attribution and spam protection -->
          {% form_hidden_fields form_type="contact" %}

          <!-- Honeypot field (visually hidden) -->
          <div class="sr-only" aria-hidden="true">
            <label for="form-company-field{% if block_id %}-{{ block_id }}{% endif %}">Company</label>
            <input type="text" name="company" id="form-company-field{% if block_id %}-{{ block_id }}{% endif %}" tabindex="-1" autocomplete="off">
          </div>

          {% if form %}
            {% for field in form %}
              <div class="relative group z-0 {% if field.errors %}has-error{% endif %}">
                <label for="{{ field.id_for_label }}" class="block text-xs uppercase tracking-widest text-sage-linen/60 mb-2">
                  {{ field.label }}
                </label>
                <div>
                    {{ field }}
                </div>
                {% if field.help_text %}
                  <span class="text-xs text-sage-linen/50 mt-2 block">{{ field.help_text }}</span>
                {% endif %}
                {% if field.errors %}
                  <span class="text-xs text-sage-terra mt-2 block font-bold" id="{{ field.auto_id }}_errors">
                    {{ field.errors.0 }}
                  </span>
                {% endif %}
              </div>
            {% endfor %}

            {% if form.non_field_errors %}
              <div class="p-4 bg-sage-terra/20 rounded-sm border border-sage-terra/30">
                {% for error in form.non_field_errors %}
                  <p class="text-xs uppercase tracking-widest text-sage-terra font-mono">{{ error }}</p>
                {% endfor %}
              </div>
            {% endif %}

          {% else %}
            <!-- Working form fields for frontend use -->
            <div class="relative group z-0">
              <input type="text" id="contact-name{% if block_id %}-{{ block_id }}{% endif %}" name="name" required placeholder=" "
                     class="peer block w-full bg-transparent border-0 border-b-2 border-sage-linen/20 py-4 text-2xl font-display text-sage-linen placeholder-transparent focus:border-sage-terra transition-colors">
              <label for="contact-name{% if block_id %}-{{ block_id }}{% endif %}"
                     class="absolute text-sage-linen/40 text-sm uppercase tracking-widest duration-300 transform -translate-y-6 scale-75 top-3 origin-[0] peer-focus:left-0 peer-focus:text-sage-terra peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:text-sage-linen/50 peer-focus:scale-75 peer-focus:-translate-y-6 cursor-text">
                Full Name
              </label>
            </div>

            <div class="relative group z-0">
              <input type="email" id="contact-email{% if block_id %}-{{ block_id }}{% endif %}" name="email" required placeholder=" "
                     class="peer block w-full bg-transparent border-0 border-b-2 border-sage-linen/20 py-4 text-2xl font-display text-sage-linen placeholder-transparent focus:border-sage-terra transition-colors">
              <label for="contact-email{% if block_id %}-{{ block_id }}{% endif %}"
                     class="absolute text-sage-linen/40 text-sm uppercase tracking-widest duration-300 transform -translate-y-6 scale-75 top-3 origin-[0] peer-focus:left-0 peer-focus:text-sage-terra peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:text-sage-linen/50 peer-focus:scale-75 peer-focus:-translate-y-6 cursor-text">
                Email Address
              </label>
            </div>

            <div class="relative group z-0">
              <input type="tel" id="contact-phone{% if block_id %}-{{ block_id }}{% endif %}" name="phone" placeholder=" "
                     class="peer block w-full bg-transparent border-0 border-b-2 border-sage-linen/20 py-4 text-2xl font-display text-sage-linen placeholder-transparent focus:border-sage-terra transition-colors">
              <label for="contact-phone{% if block_id %}-{{ block_id }}{% endif %}"
                     class="absolute text-sage-linen/40 text-sm uppercase tracking-widest duration-300 transform -translate-y-6 scale-75 top-3 origin-[0] peer-focus:left-0 peer-focus:text-sage-terra peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:text-sage-linen/50 peer-focus:scale-75 peer-focus:-translate-y-6 cursor-text">
                Phone (Optional)
              </label>
            </div>

            <div class="relative group z-0">
              <textarea id="contact-message{% if block_id %}-{{ block_id }}{% endif %}" name="message" rows="3" required placeholder=" "
                        class="peer block w-full bg-transparent border-0 border-b-2 border-sage-linen/20 py-4 text-xl font-body font-light text-sage-linen placeholder-transparent focus:border-sage-terra transition-colors resize-none"></textarea>
              <label for="contact-message{% if block_id %}-{{ block_id }}{% endif %}"
                     class="absolute text-sage-linen/40 text-sm uppercase tracking-widest duration-300 transform -translate-y-6 scale-75 top-3 origin-[0] peer-focus:left-0 peer-focus:text-sage-terra peer-placeholder-shown:scale-100 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:text-sage-linen/50 peer-focus:scale-75 peer-focus:-translate-y-6 cursor-text">
                How can we help?
              </label>
            </div>
          {% endif %}

          <!-- Form messages -->
          <div class="form-messages" role="alert" aria-live="polite"></div>

          <div class="pt-4">
            <button type="submit" class="btn btn-primary btn-submit w-full md:w-auto">
              {{ self.submit_label|default:"Send enquiry" }}
            </button>
          </div>
        </form>
        {% endwith %}
      </div>
    </div>
  </div>
</section>

{% form_attribution_script %}

<script>
(function() {
  'use strict';

  function bindForm(form) {
    if (!form || form.dataset.formBound === 'true') return;
    form.dataset.formBound = 'true';

    form.addEventListener('submit', function(e) {
      e.preventDefault();

      var formData = new FormData(form);
      var submitBtn = form.querySelector('.btn-submit');
      var messagesDiv = form.querySelector('.form-messages');
      var originalBtnText = submitBtn.textContent;

      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      messagesDiv.innerHTML = '';
      messagesDiv.className = 'form-messages';

      var csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
      var csrfToken = csrfInput ? csrfInput.value : '';

      fetch(form.action, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrfToken
        }
      })
      .then(function(response) {
        return response.json().then(function(data) {
          return { status: response.status, data: data };
        });
      })
      .then(function(result) {
        if (result.data.success) {
          messagesDiv.className = 'form-messages form-messages--success';
          var successMsg = document.createElement('p');
          successMsg.className = 'form-success-msg';
          successMsg.textContent = form.dataset.successMessage || 'Thank you for your submission.';
          messagesDiv.innerHTML = '';
          messagesDiv.appendChild(successMsg);
          form.reset();
        } else {
          messagesDiv.className = 'form-messages form-messages--error';
          messagesDiv.innerHTML = '';
          if (result.data.errors) {
            for (var field in result.data.errors) {
              result.data.errors[field].forEach(function(msg) {
                var errorP = document.createElement('p');
                errorP.className = 'form-error-msg';
                errorP.textContent = msg;
                messagesDiv.appendChild(errorP);
              });
            }
          }
          if (!messagesDiv.hasChildNodes()) {
            var fallbackP = document.createElement('p');
            fallbackP.className = 'form-error-msg';
            fallbackP.textContent = form.dataset.errorMessage || 'Something went wrong. Please try again.';
            messagesDiv.appendChild(fallbackP);
          }
        }
      })
      .catch(function() {
        messagesDiv.className = 'form-messages form-messages--error';
        var errorP = document.createElement('p');
        errorP.className = 'form-error-msg';
        errorP.textContent = form.dataset.errorMessage || 'Something went wrong. Please try again.';
        messagesDiv.innerHTML = '';
        messagesDiv.appendChild(errorP);
      })
      .finally(function() {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      });
    });
  }

  document.querySelectorAll('.js-async-form').forEach(bindForm);
})();
</script>
