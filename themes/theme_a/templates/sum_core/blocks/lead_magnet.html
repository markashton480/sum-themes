{% load wagtailcore_tags form_tags static richtext_tags %}

{% with form_definition=self.form_definition %}
  {% with generated_form=form_definition|generate_dynamic_form %}
    {% with form=form|default:generated_form %}
      {% if self.variant == 'sidebar' %}
        <div class="bg-sage-black text-sage-linen p-8 rounded-sm relative overflow-hidden group shadow-xl">
          <div class="absolute -right-10 -top-10 w-40 h-40 bg-sage-terra/20 rounded-full blur-3xl group-hover:bg-sage-terra/30 transition-colors duration-1000"></div>
          {% if self.eyebrow %}
            <span class="text-sage-terra font-bold tracking-widest uppercase text-xs mb-3 block relative z-10">{{ self.eyebrow }}</span>
          {% endif %}
          <div class="font-display text-2xl mb-2 relative z-10">{{ self.heading|richtext_inline }}</div>
          {% if self.description %}
            <div class="font-accent text-sm text-sage-linen/70 mb-8 leading-relaxed relative z-10">
              {{ self.description|richtext }}
            </div>
          {% endif %}

          <form
            action="/forms/submit/"
            method="post"
            novalidate
            class="space-y-6 relative z-10"
            data-dynamic-form
            data-success-message="{% if form_definition %}{{ self.success_message|default:form_definition.success_message|default:'Thank you for subscribing.'|escapejs }}{% else %}{{ self.success_message|default:'Thank you for subscribing.'|escapejs }}{% endif %}"
            data-error-message="Something went wrong. Please try again.">
            {% csrf_token %}

            {% if form_definition %}
              {% form_hidden_fields form_type=form_definition.slug %}
              <input type="hidden" name="form_definition_id" value="{{ form_definition.pk }}">
              <input type="hidden" name="_rendered_at" class="js-dynamic-form-timestamp" value="">
              <div class="sr-only" aria-hidden="true">
                <label for="lead-magnet-website-{{ block.id|default:'0' }}">Website</label>
                <input type="text" name="website" id="lead-magnet-website-{{ block.id|default:'0' }}" tabindex="-1" autocomplete="off">
              </div>
            {% else %}
              {% form_hidden_fields form_type="lead_magnet" %}
              <input type="hidden" name="name" value="{{ self.heading|striptags|default:'Lead Magnet Subscriber' }}">
              <input type="hidden" name="message" value="{{ self.description|striptags|default:self.heading|striptags|default:'Lead magnet signup' }}">
              <div class="sr-only" aria-hidden="true">
                <label for="lead-magnet-company-{{ block.id|default:'0' }}">Company</label>
                <input type="text" name="company" id="lead-magnet-company-{{ block.id|default:'0' }}" tabindex="-1" autocomplete="off">
              </div>
            {% endif %}

            {% if form %}
              {% for field in form %}
                <div class="relative">
                  <label for="{{ field.id_for_label }}" class="block text-xs uppercase tracking-widest text-sage-linen/60 mb-2">
                    {{ field.label }}
                  </label>
                  {{ field }}
                  {% if field.errors %}
                    <span class="text-xs text-sage-terra mt-2 block font-bold" id="{{ field.auto_id }}_errors">
                      {{ field.errors.0 }}
                    </span>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <div class="relative">
                <input
                  type="email"
                  id="lead-magnet-email-{{ block.id|default:'0' }}"
                  name="email"
                  required
                  class="peer w-full bg-transparent border-b border-sage-linen/30 py-2 text-sm text-sage-linen placeholder-transparent focus:outline-none focus:border-sage-terra transition-colors"
                  placeholder="Email Address"
                  aria-label="{{ self.email_label|default:'Email Address' }}">
                <label
                  for="lead-magnet-email-{{ block.id|default:'0' }}"
                  class="absolute left-0 -top-3.5 text-xs text-sage-linen/50 transition-all peer-placeholder-shown:text-sm peer-placeholder-shown:text-sage-linen/50 peer-placeholder-shown:top-2 peer-focus:-top-3.5 peer-focus:text-sage-terra peer-focus:text-xs">
                  {{ self.email_label|default:"Email Address" }} <span class="text-sage-terra">*</span>
                </label>
              </div>
            {% endif %}

            <div class="form-messages text-sm" role="alert" aria-live="polite"></div>

            <button type="submit" class="w-full bg-sage-terra text-white text-xs font-bold uppercase tracking-widest py-4 hover:bg-white hover:text-sage-black transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-sage-black focus-visible:ring-white min-h-[44px]" data-dynamic-form-submit>
              {{ self.submit_label|default:"Subscribe" }}
            </button>
          </form>
        </div>
      {% else %}
        <div class="text-center py-12 bg-white max-w-2xl mx-auto px-8 border border-sage-black/10 shadow-lg relative">
          {% if self.eyebrow %}
            <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-sage-linen border border-sage-black/10 px-4 py-1">
              <span class="text-xs font-bold uppercase tracking-widest text-sage-terra">{{ self.eyebrow }}</span>
            </div>
          {% endif %}
          <div class="font-display text-2xl md:text-3xl text-sage-black mb-3">{{ self.heading|richtext_inline }}</div>
          {% if self.description %}
            <div class="text-sage-label mb-8 text-base font-light">
              {{ self.description|richtext }}
            </div>
          {% endif %}

          <form
            action="/forms/submit/"
            method="post"
            novalidate
            class="{% if form %}space-y-4 max-w-lg mx-auto{% else %}flex flex-col sm:flex-row gap-4 max-w-lg mx-auto{% endif %}"
            data-dynamic-form
            data-success-message="{% if form_definition %}{{ self.success_message|default:form_definition.success_message|default:'Thank you for subscribing.'|escapejs }}{% else %}{{ self.success_message|default:'Thank you for subscribing.'|escapejs }}{% endif %}"
            data-error-message="Something went wrong. Please try again.">
            {% csrf_token %}

            {% if form_definition %}
              {% form_hidden_fields form_type=form_definition.slug %}
              <input type="hidden" name="form_definition_id" value="{{ form_definition.pk }}">
              <input type="hidden" name="_rendered_at" class="js-dynamic-form-timestamp" value="">
              <div class="sr-only" aria-hidden="true">
                <label for="lead-magnet-website-{{ block.id|default:'0' }}">Website</label>
                <input type="text" name="website" id="lead-magnet-website-{{ block.id|default:'0' }}" tabindex="-1" autocomplete="off">
              </div>
            {% else %}
              {% form_hidden_fields form_type="lead_magnet" %}
              <input type="hidden" name="name" value="{{ self.heading|striptags|default:'Lead Magnet Subscriber' }}">
              <input type="hidden" name="message" value="{{ self.description|striptags|default:self.heading|striptags|default:'Lead magnet signup' }}">
              <div class="sr-only" aria-hidden="true">
                <label for="lead-magnet-company-{{ block.id|default:'0' }}">Company</label>
                <input type="text" name="company" id="lead-magnet-company-{{ block.id|default:'0' }}" tabindex="-1" autocomplete="off">
              </div>
            {% endif %}

            {% if form %}
              {% for field in form %}
                <div class="relative">
                  <label for="{{ field.id_for_label }}" class="block text-xs uppercase tracking-widest text-sage-black/60 mb-2">
                    {{ field.label }}
                  </label>
                  {{ field }}
                  {% if field.errors %}
                    <span class="text-xs text-sage-terra mt-2 block font-bold" id="{{ field.auto_id }}_errors">
                      {{ field.errors.0 }}
                    </span>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <input type="email" name="email" placeholder="{{ self.email_label|default:'Your email address' }}" class="flex-1 px-4 py-3 border border-sage-black/20 focus:border-sage-terra focus:outline-none bg-sage-linen/30" required aria-label="{{ self.email_label|default:'Email address' }}">
            {% endif %}

            <div class="form-messages text-sm w-full" role="alert" aria-live="polite"></div>

            <button type="submit" class="bg-sage-black text-white px-8 py-3 text-sm font-bold uppercase tracking-widest hover:bg-sage-terra transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-sage-terra focus:ring-offset-2" data-dynamic-form-submit>
              {{ self.submit_label|default:"Download" }}
            </button>
          </form>
        </div>
      {% endif %}
    {% endwith %}
  {% endwith %}
{% endwith %}

{% form_attribution_script %}
<script src="{% static 'theme_a/js/dynamic_forms.js' %}" defer></script>
